# GitLab CI/CD Pipeline for DAG Harness
# Uses local runners on petting-zoo-mini via lima VM docker

stages:
  - test
  - build
  - pages

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"
  PYTHON_VERSION: "3.12"
  # Unique clone path per job to avoid git lock conflicts on concurrent runners
  GIT_CLONE_PATH: "$CI_BUILDS_DIR/$CI_CONCURRENT_ID/$CI_PROJECT_NAME"
  GIT_CLEAN_FLAGS: "-ffdx"

# Cache Python dependencies
.uv-cache: &uv-cache
  cache:
    key: "uv-$CI_JOB_NAME"
    paths:
      - .cache/uv
      - harness/.venv

# Use local docker runners via lima VM
.local-runner: &local-runner
  tags:
    - docker
    - m1
    - tinyland

# Test stage - Run pytest with coverage
test:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *uv-cache
  <<: *local-runner
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run pytest -v --cov=harness --cov-report=xml --cov-report=term-missing
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: harness/coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Lint stage - Check code quality (strict)
lint:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *uv-cache
  <<: *local-runner
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run ruff check harness/ tests/
    - uv run ruff format --check harness/ tests/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Property-based testing with Hypothesis
test-pbt:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *uv-cache
  <<: *local-runner
  script:
    - pip install uv
    - cd harness
    - uv sync --extra dev
    - uv run pytest -m pbt --hypothesis-show-statistics -v
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build documentation
build-docs:
  stage: build
  image: python:${PYTHON_VERSION}
  <<: *local-runner
  script:
    - pip install mkdocs mkdocs-material pymdown-extensions
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy to GitLab Pages
pages:
  stage: pages
  needs:
    - build-docs
  <<: *local-runner
  script:
    - echo "Deploying to GitLab Pages"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security scanning
sast:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *local-runner
  script:
    - pip install bandit
    - bandit -r harness/harness -f json -o bandit-report.json || true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
