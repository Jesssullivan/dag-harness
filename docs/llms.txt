# DAG Harness - LLM Reference

> Self-installing DAG orchestration for Ansible role deployments using LangGraph

## Installation

### Quick Install (one command)
```bash
curl -sSL https://raw.githubusercontent.com/Jesssullivan/dag-harness/main/scripts/bootstrap.sh | bash
```

### Via uv (from GitHub)
```bash
uv tool install git+https://github.com/Jesssullivan/dag-harness.git@v0.2.0
```

### Via pip (from GitHub)
```bash
pip install git+https://github.com/Jesssullivan/dag-harness.git@v0.2.0
```

### Direct wheel (fastest)
```bash
pip install https://github.com/Jesssullivan/dag-harness/releases/download/v0.2.0/dag_harness-0.2.0-py3-none-any.whl
```

### From source
```bash
git clone https://github.com/Jesssullivan/dag-harness.git
cd dag-harness/harness && uv sync
```

## Quick Start

```bash
harness bootstrap              # Interactive setup
harness bootstrap --check-only # Verify installation
```

## Core Concepts

### Box-Up-Role Workflow
14-node LangGraph DAG that processes an Ansible role:
1. validate_role - Check role exists
2. analyze_deps - Extract dependencies
3. check_reverse_deps - Verify order
4. create_worktree - Isolate changes
5. run_molecule (parallel) - Ansible tests
6. run_pytest (parallel) - Python tests
7. merge_test_results - Aggregate
8. validate_deploy - Syntax check
9. create_commit - Semantic commit
10. push_branch - Push to origin
11. create_issue - GitLab issue
12. create_mr - GitLab MR
13. human_approval - HITL gate
14. add_to_merge_train - Queue MR
15. report_summary - Final report

### Waves
Roles in 5 waves (0-4) for dependency ordering.

## CLI Commands

### Setup
```bash
harness bootstrap              # Interactive setup
harness bootstrap --check-only # Verify state
harness credentials            # Discover credentials
harness init                   # Create config
```

### Workflow
```bash
harness box-up-role <role>     # Execute workflow
harness resume <id>            # Resume paused
harness resume <id> --approve  # Approve gate
harness resume <id> --reject   # Reject
```

### Status
```bash
harness status [role]          # Role status
harness list-roles             # List roles
harness list-roles --wave 2    # Filter by wave
harness deps <role>            # Dependencies
harness deps <role> --reverse  # Reverse deps
harness worktrees              # List worktrees
harness graph                  # Show DAG
```

### HOTL (Autonomous)
```bash
harness hotl start             # Start autonomous
harness hotl status            # Check status
harness hotl stop              # Stop gracefully
```

### Database
```bash
harness db stats               # Statistics
harness db backup <path>       # Backup
harness check                  # Self-checks
```

### Costs
```bash
harness costs report           # Cost breakdown
harness costs daily            # Daily totals
harness costs session <id>     # Session costs
```

## MCP Tools (40+ tools, 8 categories)

### role_management (7)
- list_roles, get_role_status, get_dependencies
- get_reverse_dependencies, get_deployment_order
- get_dependency_graph, sync_roles_from_filesystem

### workflow (5)
- get_workflow_status, hotl_status
- hotl_cancel_executions, hotl_get_recent_executions
- hotl_get_health

### worktree (3)
- list_worktrees, get_worktree, sync_worktrees

### testing (2)
- get_test_history, get_active_regressions

### agent (6)
- agent_report_progress, agent_request_intervention
- agent_log_file_operation, agent_get_session_context
- agent_list_sessions, agent_get_file_changes

### costs (3)
- track_token_usage, get_session_costs, get_cost_summary

### search (2)
- search_tools, list_tool_categories

## Key Files

| Path | Purpose |
|------|---------|
| harness/harness/cli.py | CLI entry point |
| harness/harness/dag/langgraph_engine.py | LangGraph workflow |
| harness/harness/db/state.py | SQLite state |
| harness/harness/mcp/server.py | MCP server |
| harness/harness/bootstrap/ | Self-bootstrap |
| .claude/settings.json | MCP config |
| .claude/hooks/ | Tool hooks |

## Configuration (harness.yml)

```yaml
db_path: harness/harness.db
repo_root: /path/to/roles

gitlab:
  project_path: group/project
  default_assignee: username

worktree:
  base_path: /path/to/worktrees
  branch_prefix: sid/

testing:
  molecule_required: true
  molecule_timeout: 600

waves:
  0: { name: Foundation, roles: [common] }
```

## Environment Variables

| Variable | Purpose |
|----------|---------|
| GITLAB_TOKEN | GitLab API (required) |
| HARNESS_DB_PATH | Database path |
| DISCORD_WEBHOOK_URL | Notifications |
| LANGCHAIN_TRACING_V2 | LangSmith tracing |

## Database Tables

- roles - Role metadata with wave
- role_dependencies - DAG edges
- worktrees - Git worktree state
- workflow_executions - Execution tracking
- test_runs - Test history
- token_usage - Cost tracking

## Requirements

- Python 3.11+
- uv package manager
- Git with worktree support
- GitLab API access

## Links

- Docs: https://disposable-ansible-dag.ephemera.xoxd.ai
- GitHub: https://github.com/Jesssullivan/dag-harness
- GitLab: https://gitlab.com/tinyland/projects/dag-harness
- Author: Jess Sullivan (xoxd.ai) â€” Tinyland.dev, Inc.
